<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Taskapp</title>

<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="byps.js"></script>
<script type="text/javascript" src="taskapp.js"></script>

<script type="text/javascript">
	var url = "/taskapp-srv/taskapp"
	var bclient = null;
	
	// Implementation of TaskNotify
	var TaskNotifyImpl = function() {
		
		this.receiveTask = function(task) {
			var tab = document.getElementById("taskList");
			insertTaskRow(tab, task);
		};
		
	};
	TaskNotifyImpl.prototype = new task.app.BSkeleton_TaskNotify();


	function init() {

		var wire = new byps.BWireClient(url, 0, 120);
		wire.getServletPathForNegotiationAndAuthentication = function() {
			return "/taskappauth/auth";
		};

		var transportFactory = new byps.BTransportFactory(
				task.app.BApiDescriptor_Taskapp.instance(), wire, 1);

		this.bclient = task.app.createClient_Taskapp(transportFactory);
		
		this.bclient.addRemote(new TaskNotifyImpl());

		this.bclient.start();
	}

	window.onload = function() {
		init();
	}

	function updateTaskList() {

		// get tasks from server
		var tasks = bclient.taskService.getTasks();

		var tab = document.getElementById("taskList");

		// clear all data rows
		while (tab.rows.length > 1)
			tab.deleteRow(1);

		// insert rows
		for (var i = 0; i < tasks.length; i++) {
			insertTaskRow(tab, tasks[i]);
		}
	}
	
	function insertTaskRow(tab, task) {
		var colIdx = 0;
		var row = tab.insertRow(tab.rows.length);
		row.insertCell(colIdx++).innerHTML = task.id;
		row.insertCell(colIdx++).innerHTML = task.userName;
		row.insertCell(colIdx++).innerHTML = task.dueDate;
		row.insertCell(colIdx++).innerHTML = task.todo;
		row.insertCell(colIdx++).innerHTML = getTaskListProperties(task);
		row.insertCell(colIdx++).innerHTML = getTaskListAttachments(task);
		
		var btnId = "btn" + tab.rows.length;
		row.insertCell(colIdx++).innerHTML = '<input type="button" id="' + btnId + '" '
				+ 'value="compute" onclick="computeChecksum(' +task.id + ')" />';
	}
	
	function computeChecksum(taskId) {
		var atts = bclient.taskService.getTaskAttachments(taskId);
		var calc = bclient.taskService.getCalculationService();
		if (calc) {
			calc.computeSimpleChecksum(atts, function(sum, ex) {
				alert("Checksum=" + sum + ", error=" + ex);
			});
		}
		else {
			alert("Calculation service not connected.");
		}
	}

	function getTaskListProperties(task) {
		var ret = "";
		if (task.properties) {
			for ( var k in task.properties) {
				ret += k + "=" + task.properties[k] + "<br/>";
			}
		}
		return ret;
	}

	function getTaskListAttachments(task) {
		var ret = "";
		if (task.attachments) {
			for (var i = 0; i < task.attachments.length; i++) {
				var stream = task.attachments[i];
				ret += "<a target='_blank' href='" + stream.url + "'>attachment" + (i + 1)
						+ "</a><br/>";
			}
		}
		return ret;
	}

	function addTask() {
		var t = new task.app.TaskInfo();
		t.id = document.getElementById("taskId").value;
		t.userName = document.getElementById("taskUserName").value;
		t.dueDate = new Date(document.getElementById("taskDueDate").value);
		t.todo = document.getElementById("taskTodo").value;

		bclient.taskService.addTask(t, function(result, ex) {
			if (ex)
				alert(ex);
		});
	}
	
function onUploadResult() {
	
	// Get DOM object of iframe body
	var iFrameBody;
	var iFrame = document.getElementById('uploadResultFrame');
	if (iFrame.contentDocument) { // FF
		iFrameBody = iFrame.contentDocument.getElementsByTagName('body')[0];
	} else if (iFrame.contentWindow) { // IE
		iFrameBody = iFrame.contentWindow.document.getElementsByTagName('body')[0];
	}
	
	// Stream IDs are in the iframe's body
	var ret = iFrameBody.innerHTML;
	if (ret) {

		// Obtain stream IDs in an array
		var streamIds = JSON.parse(ret);
		
		// Create BContentStream objects
		var attachments = [];
		for (var i = 0; i < streamIds.length; i++) {
			attachments[i] = new byps.BContentStream();
			attachments[i].streamId = streamIds[i];
		}
		
		// Add new task
		var t = new task.app.TaskInfo();
		t.id = document.getElementById("taskId").value;
		t.userName = document.getElementById("taskUserName").value;
		t.dueDate = new Date(document.getElementById("taskDueDate").value);
		t.todo = document.getElementById("taskTodo").value;
		t.attachments = attachments;

		bclient.taskService.addTask(t, function(result, ex) {
			if (ex)
				alert(ex);
		});
	}

	return ret;
}
	
</script>

<style type="text/css">
table {
	border-spacing: 5px;
}

td {
	background-color: #EEEEEE;
}
</style>

</head>

<body>
	<table>
		<tr>
			<td>Tasklist <input type="button" value="Update"
				onclick="updateTaskList()" />
			</td>
		</tr>
		<tr>
			<td>
				<table id="taskList">
					<tr>
						<td>ID</td>
						<td>User Name</td>
						<td>Due Date</td>
						<td>TODO</td>
						<td>Properties</td>
						<td>Attachments</td>
						<td>Checksum</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
	<br>
	<form id="addTaskForm" method="post" enctype="multipart/form-data"
		action="/taskapp-srv/taskapp?uploadHandler=htmlform"
		target="uploadResultFrame">
		<table>
			<tr>
				<td>Add Task</td>
			</tr>
			<tr>
				<td>
					<table id="taskList">
						<tr>
							<td>ID</td>
							<td>User Name</td>
							<td>Due Date</td>
							<td>TODO</td>
							<td>Attachments</td>
						</tr>
						<tr>
							<td><input id="taskId" /></td>
							<td><input id="taskUserName" /></td>
							<td><input id="taskDueDate" /></td>
							<td><input id="taskTodo" /></td>
							<td><input id="taskAtts" name="files[]" type="file" multiple></td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td><input type="submit" value="Add" /></td>
			</tr>
		</table>
		<iframe id="uploadResultFrame" name="uploadResultFrame"
			onload="onUploadResult()" style="visibility: hidden; display: none">
		</iframe>
	</form>

</body>
</html>